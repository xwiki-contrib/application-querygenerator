<?xml version="1.0" encoding="UTF-8"?>

<!--
 * See the NOTICE file distributed with this work for additional
 * information regarding copyright ownership.
 *
 * This is free software; you can redistribute it and/or modify it
 * under the terms of the GNU Lesser General Public License as
 * published by the Free Software Foundation; either version 2.1 of
 * the License, or (at your option) any later version.
 *
 * This software is distributed in the hope that it will be useful,
 * but WITHOUT ANY WARRANTY; without even the implied warranty of
 * MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE. See the GNU
 * Lesser General Public License for more details.
 *
 * You should have received a copy of the GNU Lesser General Public
 * License along with this software; if not, write to the Free
 * Software Foundation, Inc., 51 Franklin St, Fifth Floor, Boston, MA
 * 02110-1301 USA, or see the FSF site: http://www.fsf.org.
-->

<xwikidoc version="1.3" reference="Macros.QueryGenerator" locale="">
  <web>Macros</web>
  <name>QueryGenerator</name>
  <language/>
  <defaultLanguage/>
  <translation>0</translation>
  <creator>xwiki:XWiki.Admin</creator>
  <creationDate>1451602800000</creationDate>
  <parent>Main.WebHome</parent>
  <author>xwiki:XWiki.Admin</author>
  <contentAuthor>xwiki:XWiki.Admin</contentAuthor>
  <date>1451602800000</date>
  <contentUpdateDate>1451602800000</contentUpdateDate>
  <version>1.1</version>
  <title>Query Generator</title>
  <comment/>
  <minorEdit>false</minorEdit>
  <syntaxId>xwiki/2.1</syntaxId>
  <hidden>true</hidden>
  <content>{{velocity}}
{{html}}
&lt;form action =""&gt;
Generate form for class: &lt;select name="classname"&gt;
#if($request.classname)
#set($classname = $request.classname)
#else
#set($classname = "XWiki.XWikiUsers")
#end
#set($classes = $xwiki.classList)
#foreach($classn in $classes)
&lt;option value="${classn}" #if($classname==$classn) selected #end&gt;$classn&lt;/option&gt;
#end
&lt;/select&gt;
&lt;input type="submit" value="Go" /&gt;
&lt;/form&gt;
{{/html}}


#set($qg = $xwiki.parseGroovyFromPage("Macros.QueryGeneratorGroovy"))
#set($ok = $qg.setXWiki($xwiki, $context))

## Code
#set($query = $qg.createQueryFromRequest($classname))
#set($class = $xwiki.getDocument($classname).xWikiClass)

#set($searchdisplayfields = $query.searchdisplayfields)
#set($fields = $xwiki.getDocument($classname).xWikiClass.propertyNames)
#if($searchdisplayfields.size()==0)
#set($searchdisplayfields = "")
#end
#set($mydoc = $xwiki.getDocument("Sandbox.Sandbox"))
#set($ok = $mydoc.newObject($classname))
#set($ok = $mydoc.use($classname))
{{html clean=false}}
&lt;form action="" method="get"&gt;
&lt;input type="hidden" name="query" value="1" /&gt;
&lt;input type="hidden" name="classname" value="$classname" /&gt;
&lt;table border="0"&gt;
#set($even = true)
#foreach($field in $fields)
#if($even==true)
&lt;tr&gt;
#end
&lt;td&gt;&lt;b&gt;$mydoc.displayPrettyName($field)&lt;/b&gt;&lt;/td&gt;&lt;td&gt;$qg.displaySearch($field, $classname, $query)&lt;/td&gt;
#if($even==false)
&lt;/tr&gt;
#end
 #set($even = !$even)
#end
#if($even==false)
&lt;/tr&gt;
#end
&lt;tr&gt;&lt;td&gt;&lt;b&gt;Columns&lt;/b&gt;&lt;/td&gt;&lt;td&gt;$qg.displaySearchColumns($classname, "", $query)&lt;/td&gt;
&lt;td&gt;&lt;b&gt;Order by&lt;/b&gt;&lt;/td&gt;&lt;td&gt;$qg.displaySearchOrder($classname, "", $query)&lt;/td&gt;&lt;/tr&gt;
&lt;/table&gt;
&lt;input type="submit" value="Go" /&gt;
&lt;/form&gt;

#if($request.query)
#if($request.order)
#set($order=$request.order)
#end

#set($xwlquery = $qg.makeQuery($query))
#set($columns = [])
#foreach($field in $query.searchdisplayfields)
 #set($ok = $columns.add($field.replaceAll("${classname}_","")))
#end
#set($columns = $stringtool.join($columns,","))
&lt;ul&gt;
&lt;li&gt;&lt;b&gt;Query (xwql):&lt;/b&gt;  $xwlquery&lt;/li&gt;
&lt;li&gt;&lt;b&gt;Columns:&lt;/b&gt; $columns&lt;/li&gt;
&lt;li&gt;&lt;b&gt;Macro:&lt;/b&gt; {{query query="$xwlquery" class="$classname" columns="$columns" headers="1" links="0" actions="1" /}}
&lt;/li&gt;
&lt;ul&gt;
{{/html}}

{{query query="$xwlquery" class="$classname" columns="$columns" headers="1" links="0" actions="1" /}}

#end

#if($request.debug)
DEBUG: $qg.getDebug()
#end
{{/velocity}}</content>
</xwikidoc>
