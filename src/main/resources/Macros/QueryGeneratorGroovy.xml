<?xml version="1.0" encoding="UTF-8"?>

<xwikidoc version="1.3" reference="Macros.QueryGeneratorGroovy" locale="">
  <web>Macros</web>
  <name>QueryGeneratorGroovy</name>
  <language/>
  <defaultLanguage/>
  <translation>0</translation>
  <creator>xwiki:XWiki.Admin</creator>
  <creationDate>1514761200000</creationDate>
  <parent>Macros.QueryGenerator</parent>
  <author>xwiki:XWiki.Admin</author>
  <contentAuthor>xwiki:XWiki.Admin</contentAuthor>
  <date>1514761200000</date>
  <contentUpdateDate>1514761200000</contentUpdateDate>
  <version>1.1</version>
  <title>Query Generator Groovy Helper</title>
  <comment/>
  <minorEdit>false</minorEdit>
  <syntaxId>xwiki/2.1</syntaxId>
  <hidden>true</hidden>
  <content>import com.xpn.xwiki.util.Util;
import org.apache.ecs.xhtml.input;
import org.apache.ecs.xhtml.select;
import org.apache.ecs.xhtml.option;
import org.apache.commons.lang.StringUtils;
import java.text.SimpleDateFormat;
import com.xpn.xwiki.objects.classes.ListClass;

public class QueryGenerator {
 def xwiki;
 def context;
 def request;
 def services;

 def debugStr = "";

 public addDebug(str) {
   debugStr += str + "\n";
 }

 public getDebug() {
   return debugStr;
 }

 public setXWiki(xwiki, context, services) {
   this.xwiki = xwiki;
   this.context = context;
   this.request = context.request;
   this.services = services;
 }

 public getPropertyList(baseClass) {
   def propList = new ArrayList();
   propList.addAll(baseClass.getPropertyNames());
   propList.add("doc.title");
   propList.add("doc.content");
   return propList;
 }

 public Map createQueryFromRequest(className) {
   Map query = new HashMap();
   query.put("searchclass", className);
   String[] columns = request.getParameterValues("searchdisplayfields");
   query.put("searchdisplayfields", columns);
   String[] aggcolumns = request.getParameterValues("searchaggfields");
   query.put("searchaggfields", aggcolumns);
    String[] order = request.getParameterValues("searchorder");
   query.put("searchorder", order); 

   def baseClass = xwiki.getDocument(className).getxWikiClass();
   def propList = getPropertyList(baseClass);

   for (propname in propList) {
       for (paramName in request.getParameterNames()) {
        if (paramName.startsWith(className + "_" + propname)) {
         def list = Arrays.asList(request.getParameterValues(paramName));
         def value = null;
         if (list.size()&gt;0) {  
           value = (list.size()==1) ? list.getAt(0) : list;
           query.put(paramName.substring(className.length()+1), value);
         }
        }
       }
   }
   return query;
 }

 def displaySearchColumns(className, prefix, query) {
        addSelectize();
        def baseClass = xwiki.getDocument(className).getxWikiClass();
        def select = new select(prefix + "searchdisplayfields", 10);
        select.setMultiple(true);
        select.setName(prefix + "searchdisplayfields");
        select.setID(prefix + "searchdisplayfields");
        select.setClass("suggest-columns");
        
        List&lt;String&gt; list = Arrays.asList(baseClass.getPropertyNames());
        Map&lt;String, String&gt; prettynamesmap = new HashMap&lt;String, String&gt;();
        for (int i = 0; i &lt; list.size(); i++) {
            String propname = list.get(i);
            list.set(i, prefix + propname);
            prettynamesmap.put(prefix + propname, baseClass.get(propname).getPrettyName());
        }

        def selectlist = query.get("searchdisplayfields");
        if (selectlist==null) selectlist = new ArrayList();

        // Add options from Set
        for (value in list) {
            String displayValue = prettynamesmap.get(value);
            def option = new option(displayValue, displayValue);
            option.setValue(value);
            if (selectlist.contains(value)) {
                option.setSelected(true);
            }
            option.addElement(displayValue);
            select.addElement(option);
        }

        return select.toString();
    }

    def addAggregate(select, selectlist, name, displayName, value, displayValue) {
       def sdisplayValue = ((displayValue==null) ? "" : displayValue);
       def sdisplayName = "${displayName} ${sdisplayValue}";
       def aggOption = new option(sdisplayName, sdisplayName);
       def svalue = "AGG_${name}";
       if (value!=null)
        svalue += "_" + value;
       aggOption.setValue(svalue);
       if (selectlist.contains(svalue)) {
          aggOption.setSelected(true);
       }
       aggOption.addElement(sdisplayName);
       select.addElement(aggOption);
    }
 
    def displaySearchAggregateColumns(className, prefix, query) {
        def baseClass = xwiki.getDocument(className).getxWikiClass();
        def select = new select(prefix + "searchaggfields", 10);
        select.setMultiple(true);
        select.setName(prefix + "searchaggfields");
        select.setID(prefix + "searchaggfields");
        select.setClass("suggest-columns");        

        List&lt;String&gt; list = Arrays.asList(baseClass.getPropertyNames());
        Map&lt;String, String&gt; prettynamesmap = new HashMap&lt;String, String&gt;();
        for (int i = 0; i &lt; list.size(); i++) {
            String propname = list.get(i);
            list.set(i, prefix + propname);
            prettynamesmap.put(prefix + propname, baseClass.get(propname).getPrettyName());
        }

        def selectlist = query.get("searchaggfields");
        if (selectlist==null) selectlist = new ArrayList();
        addAggregate(select, selectlist, "COUNT", "count documents", null, null)
        addAggregate(select, selectlist, "COUNTDISTINCT", "count distinct documents", null, null)
        
        // Add aggregate options from Set
        for (value in list) {
            String displayValue = prettynamesmap.get(value);
            def propDef = baseClass.get(value)
            if (propDef.type.equals("NumberClass")) {
               addAggregate(select, selectlist, "SUM", "sum", value, displayValue);
               addAggregate(select, selectlist, "AVG", "avg", value, displayValue);
            } else {
               addAggregate(select, selectlist, "COUNT", "count", value, displayValue);
               addAggregate(select, selectlist, "COUNTDISTINCT", "count distinct", value, displayValue);
            }
        }
        return select.toString();
    }

 def displaySearchOrder(className, prefix, query) {
        def baseClass = xwiki.getDocument(className).getxWikiClass();
        def select = new select(prefix + "searchorder", 1);
        select.setMultiple(false);
        select.setName(prefix + "searchorder");
        select.setID(prefix + "searchorder");
        select.setClass("suggest-columns");        

        def defaultOption = new option("","No sorting");
        defaultOption.addElement("No sorting");
        defaultOption.setValue("__defaultsorting__");
        select.addElement(defaultOption);
           
        List&lt;String&gt; list = Arrays.asList(baseClass.getPropertyNames());
        Map&lt;String, String&gt; prettynamesmap = new HashMap&lt;String, String&gt;();
        for (int i = 0; i &lt; list.size(); i++) {
            String propname = list.get(i);
            list.set(i, prefix + propname);
            prettynamesmap.put(prefix + propname, baseClass.get(propname).getPrettyName());
        }

        def selectlist = query.get("searchorder");
        if (selectlist==null) selectlist = new ArrayList();

        // Add options from Set
        for (value in list) {
           def queryValue = "";
           def propClass =  baseClass.get(value);
           if (propClass.type.contains("Computed")) {
               if (propClass.getProperty('customDisplay').value == '{{include reference="AppWithinMinutes.Title"/}}') {
                 queryValue = "doc.title";
               } else if (propClass.getProperty('customDisplay').value == '{{include reference="AppWithinMinutes.Content"/}}') {
                 // Sorting on content is not recommended and not supported by livetable
                 // queryValue = "doc.content";
               }
           } else {
                queryValue = value;
           }

           if (queryValue!="") {
            String displayValue = prettynamesmap.get(value);
            def option = new option(displayValue + " asc", displayValue + " asc");
            option.addElement(displayValue + " asc");
            option.setValue(queryValue + " asc");
            if (selectlist.contains(queryValue + " asc")) {
                option.setSelected(true);
            }
            select.addElement(option);

            def optionDesc = new option(displayValue + " desc", displayValue + " desc");
            optionDesc.addElement(displayValue + " desc");
            optionDesc.setValue(queryValue + " desc");
            if (selectlist.contains(queryValue + " desc")) {
                optionDesc.setSelected(true);
            }
            select.addElement(optionDesc);
           }
        }

        return select.toString();
    }

 def makeQuery(query) {
        def xwqlselect = new StringBuffer();
        def xwqlfrom = new StringBuffer();
        def xwqlwhere = new StringBuffer();
        def xwqlgroupBy = new StringBuffer();
        def xwqlorder = new StringBuffer();

        def hasAggregate = false;
        def hasRelationalStorage = false;
        def className = query.get("searchclass");
        def baseClass = xwiki.getDocument(className).getxWikiClass()

        def selectList = new ArrayList();
        def groupByList = new ArrayList();
        def columns = query.get("searchdisplayfields");
        def aggColumns = query.get("searchaggfields");
        for (col in columns) {
             def propClass = baseClass.get(col);
             selectList.add("obj.${col}");
             groupByList.add("obj." + col);
            
             // check compatibility of XWQL with multiselect relational storage group by fields
             if (propClass.getProperty("relationalStorage") &amp;&amp; propClass.getProperty("multiSelect") 
                 &amp;&amp; propClass.getProperty("relationalStorage").getValue()==1 
                 &amp;&amp; propClass.getProperty("multiSelect").getValue()==1) {
               hasRelationalStorage = true;
            }
        }
        for (col in aggColumns) {
           if (col.startsWith("AGG_")) {
             hasAggregate = true;
             def colName = col.replaceAll("AGG_(.*?)_","");
             if (col=="AGG_COUNT") {
               selectList.add("count(doc.fullName)");  
             } else if (col=="AGG_COUNTDISTINCT") {
               selectList.add("count(distinct doc.fullName)");  
             } else if (col.startsWith("AGG_SUM")) {
               selectList.add("sum(obj.${colName})");
             } else if (col.startsWith("AGG_AVG")) {
               selectList.add("avg(obj.${colName})");
             } else if (col.startsWith("AGG_COUNT")) {
               selectList.add("count(obj.${colName})");
             } else if (col.startsWith("AGG_COUNTDISTINCT")) {
               selectList.add("count(distinct obj.${colName})");
             }
           }
        }

        if (hasAggregate &amp;&amp; hasRelationalStorage) {
           context.put("hasRelationalStorageGroupBy","1")
        }

        xwqlselect.append(selectList.join(","))
        xwqlgroupBy.append(groupByList.join(","))

        xwqlfrom.append("Document as doc, doc.object(" + className + ") as obj");
        def clauseList = new ArrayList();
        for (propName in baseClass.getPropertyNames()) {
          def propClass = baseClass.get(propName);
          if (propClass.type=="xxx") {
          } else if (propClass.type.contains("ListClass")) {
            clauseList.addAll(makeQueryList(propClass, propName, propName, "obj.", query));
          } else if (propClass.type.contains("BooleanClass")) {
            clauseList.addAll(makeQueryNumber(propClass, propName, propName, "obj.", query));
          } else if (propClass.type.contains("DateClass")) {
            clauseList.addAll(makeQueryDate(propClass, propName, propName, "obj.", query));
          } else {
            clauseList.addAll(makeQueryString(propClass, propName, propName, "obj.", query));
          }
        }

        xwqlwhere.append("doc.fullName not like '%Template'");
        for (clause in clauseList)
         xwqlwhere.append(" and " + clause); 
        
        if (query.get("searchorder")!=null &amp;&amp; query.get("searchorder").size()&gt;0) {
         def searchorder = query.get("searchorder").getAt(0)
         if (searchorder!="" &amp;&amp; searchorder!="__defaultsorting__") {
          if (searchorder.startsWith("doc.")) {
           xwqlorder.append(searchorder)
          } else {
            def sortField = searchorder.substring(0, searchorder.indexOf(" "));
            def sortDir = searchorder.substring(searchorder.indexOf(" ") + 1);
            def propClass = baseClass.get(sortField)
            
            // check compatibility of XWQL with multiselect relational storage sort fields
            if (propClass.getProperty("relationalStorage") &amp;&amp; propClass.getProperty("multiSelect") &amp;&amp; propClass.getProperty("relationalStorage").getValue()==1 &amp;&amp; propClass.getProperty("multiSelect").getValue()==1) {
               context.put("hasRelationalStorageSort","1")
            }

            // check for computed fields which are not compatible
            if (propClass.type.contains("Computed")) {
               if (propClass.getProperty('customDisplay').value == '{{include reference="AppWithinMinutes.Title"/}}') {
                 xwqlorder.append("doc.title ${sortDir}");
               } else if (propClass.getProperty('customDisplay').value == '{{include reference="AppWithinMinutes.Content"/}}') {
                 xwqlorder.append("doc.content ${sortDir}");
               } else {
                 context.put("hasComputedFieldSort","1");
               }
            } else {
                 xwqlorder.append("obj." + searchorder);
            }
          }
         }
        }

        String xwql = "select doc.fullName";
        if (hasAggregate) {
          xwql = "select " + xwqlselect;
        }

        xwql += " from " + xwqlfrom.toString();
        if (xwqlwhere.length() != 0)
            xwql += " where " + xwqlwhere.toString();
        if (hasAggregate &amp;&amp; xwqlgroupBy.length() != 0)
            xwql += " group by " + xwqlgroupBy.toString();
        if (xwqlorder.length() != 0) {
            xwql += " order by " + xwqlorder.toString();
        }

        return xwql;
  }

  def makeLiveTableFilters(query) {
        def ltFilters = "";  
        def className = query.get("searchclass");
        def baseClass = xwiki.getDocument(className).getxWikiClass()
        
        def clauseList = new ArrayList();
        def propList = getPropertyList(baseClass);

        for (propName in propList) {
          def values = query.get(propName);
          if (propName.startsWith("doc.") &amp;&amp; (values!=null) &amp;&amp; (values!="")) {           
            clauseList.add(propName + "=" + values);    
          } else {
           def propClass = baseClass.get(propName);
           if ((values != null) &amp;&amp; (!values.equals(""))) {
            if (values instanceof String) {
             clauseList.add(propName + "=" + values);
            } else {
             String[] valuesarray = (String[]) values;
             for (int i = 0; i &lt; valuesarray.length; i++) {
                 clauseList.add(propName + "=" + valuesarray[i]);
             }
           }
           if (propClass.type.contains("DateClass")) {
             def value1 = query.get(propName + "_lessthan");
             def value2 = query.get(propName + "_morethan");
             def format = propClass.getProperty('dateFormat').value;
             def sdformat = new SimpleDateFormat(format);
             def dvalue1 = (value1==null || value1=="") ? null : sdformat.parse(value1);
             def dvalue2 = (value2==null || value2=="") ? null : sdformat.parse(value2);
             if (dvalue1!=null) 
              clauseList.add(propName + "=" + dvalue1 + "-" + dvalue2);
           }
          }
         }
        }   
        return clauseList.join("&amp;");
  }

 public String displaySearch(fieldName, className, query) {
    def baseClass = xwiki.getDocument(className).getxWikiClass();
    def propClass = baseClass.get(fieldName);
    def prefix = "" + className + "_";
    def name = "";
    if (propClass!=null &amp;&amp; propClass.type.contains("Computed")) {
       if (propClass.getProperty('customDisplay').value == '{{include reference="AppWithinMinutes.Title"/}}') {
             name = "doc.title";
       } else if (propClass.getProperty('customDisplay').value == '{{include reference="AppWithinMinutes.Content"/}}') {
              name = "doc.content";
       }
     } else {
                name = fieldName;
     }

    if (name=="") {
       return "";
    } else {
       if (propClass.type.contains("BooleanClass")) {
         return displaySearchRadio(propClass, name, prefix, query);
       } else if (propClass.type.contains("ListClass")) {
         return displaySearchList(propClass, name, prefix, query);
       } else if (propClass.type.contains("DateClass")) {
         return displayDateString(propClass, name, prefix, query);
       } else {
         return displaySearchString(propClass, name, prefix, query);
       }
    }
 }

 /*
  String Field
 */
 def displaySearchString(propClass, name, prefix, query) {
        def input = new input();
        input.setType("text");
        input.setName(prefix + name);
        input.setID(prefix + name);
        def fieldFullName = name;
        def data = query.get(fieldFullName);
        String value = "";
        if (data!=null) {
            if (data instanceof List) {
              value= data.getAt(0);
            } else {
             value = data;
            }
        }
        if (value != null) {
            input.setValue(value.toString());
        }
        return input.toString();
 }

 /*
  Date Field
 */
 def displayDateString(propClass, name, prefix, query) {
        xwiki.ssfx.use('uicomponents/widgets/datepicker/calendarDateSelect.css', true)
        xwiki.jsfx.use('uicomponents/widgets/datepicker/calendarDateSelect.js', ['forceSkinAction': true, 'language': context.locale])
        xwiki.jsfx.use('uicomponents/widgets/datepicker/simpleDateFormat.js', ['forceSkinAction': true, 'language': context.locale])
        xwiki.ssfx.use('uicomponents/widgets/datepicker/dateTimePicker.css', true)
        xwiki.jsfx.use('uicomponents/widgets/datepicker/dateTimePicker.js')

        def fieldFullName = name;
        def format = propClass.getProperty('dateFormat').value;
        def input1 = new input();
        input1.setType("text");
        input1.setName(prefix + name + "_lessthan");
        input1.setID(prefix + name + "_lessthan");
        input1.setClass("datetime");
        input1.setTitle(format);
        def data1 = query.get(fieldFullName + "_lessthan");
        String value1 = "";
        if (data1!=null) {
            if (data1 instanceof List) {
              value1 = data1.getAt(0);
            } else {
             value1 = data1;
            }
        }
        if (value1 != null) {
            input1.setValue(value1.toString());
        }
        def input2 = new input();
        input2.setType("text");
        input2.setName(prefix + name + "_morethan");
        input2.setID(prefix + name + "_morethan");
        input2.setClass("datetime");
        input2.setTitle(format);
        def data2 = query.get(fieldFullName + "_morethan");
        String value2 = "";
        if (data2!=null) {
            if (data2 instanceof List) {
              value2 = data2.getAt(0);
            } else {
             value2 = data2;
            }
        }
        if (value2 != null) {
            input2.setValue(value2.toString());
        }
 
        return "&lt;b&gt;From:&lt;/b&gt;&lt;br/&gt;" + input1.toString() + "&lt;br/&gt;&lt;b&gt;To:&lt;/b&gt;&lt;br/&gt;" + input2.toString();
 }

 def makeQueryString(propClass, name, prefix, queryTablePrefix, map) {
        def clauseList = new ArrayList();
        def fullPropName = queryTablePrefix + name;

        String value = (String) map.get(prefix);
        if ((value != null) &amp;&amp; (!value.equals(""))) {
            String startsWith = (String) map.get(prefix + "startswith");
            String endsWith = (String) map.get(prefix + "endswith");
            if ("1".equals(startsWith)) {
                clauseList.add("lower(" + fullPropName + ") like '" + value.toLowerCase() + "%'");
            } else if ("1".equals(endsWith)) {
                clauseList.add("lower(" + fullPropName + ") like '%" + value.toLowerCase() + "'");
            } else {
                clauseList.add("lower(" + fullPropName + ") like '%" + value.toLowerCase() + "%'");
            }
        }

        value = (String) map.get(prefix + "exact");
        if ((value != null) &amp;&amp; (!value.equals(""))) {
            clauseList.add(fullPropName + "='" + value + "'");
        }

        value = (String) map.get(prefix + "not");
        if ((value != null) &amp;&amp; (!value.equals(""))) {
            clauseList.add(fullPropName + "!='" + value + "'");
        }
        return clauseList;
  }

  /*
   List Field
  */
  def displaySearchList(propClass, name, prefix, query) {
    def displayType = propClass.getBasePropertyClass().getDisplayType()
    if (displayType.equals("input")) {
            return displaySearchSelect(propClass, name, prefix, query);
    } else if (displayType.equals("radio") || displayType.equals("checkbox")) {
            return displaySearchCheckbox(propClass, name, prefix, query);
    } else {
            return displaySearchSelect(propClass, name, prefix, query);
    }
  }

  def displaySearchCheckbox(propClass, name, prefix, query) {
        StringBuffer buffer = new StringBuffer();
        def list = propClass.getListValues();
        def fieldFullName = name;
        def selectlist = query.get(fieldFullName);
        def pClass = propClass.getBasePropertyClass();
       
        // Add options from Set
        for (rawvalue in list) {
            String value = pClass.getElementValue(rawvalue);
            String display = pClass.getDisplayValue(rawvalue, fieldFullName, propClass.getMapValues(), context.getContext());
            def radio =
                new input(input.checkbox, prefix + name, value);

            if (selectlist!=null &amp;&amp; selectlist.contains(value)) {
                radio.setChecked(true);
            }
            radio.addElement(display);
            buffer.append(radio.toString());
            buffer.append("&lt;br/&gt;");            
        }
        return buffer.toString();
    }

  def displaySearchRadio(propClass, name, prefix, query) {
        StringBuffer buffer = new StringBuffer();
        def fieldFullName = name;
        def selectlist = query.get(fieldFullName);
        def pClass = propClass.getBasePropertyClass();
       
        def radio1 = new input(input.radio, prefix + name, "1");
        radio1.addElement("Yes");
        def radio2 = new input(input.radio, prefix + name, "0");
        radio2.addElement("No");
        if (selectlist!=null) {
          if (selectlist.contains("1")) {
            radio1.setChecked(true);
          } else if (selectlist.contains("0")) {
            radio2.setChecked(true);
          }
        }
        buffer.append(radio1.toString());
        buffer.append("&lt;br /&gt;");
        buffer.append(radio2.toString());
        return buffer.toString();
    }

 def addSelectize() {
       xwiki.linkx.use(services.webjars.url('selectize.js', 'css/selectize.bootstrap3.css'), ['type': 'text/css', 'rel': 'stylesheet'])
        xwiki.ssfx.use('uicomponents/suggest/xwiki.selectize.css', true)
        xwiki.jsx.use("Macros.QueryGenerator");
        xwiki.jsfx.use('uicomponents/suggest/suggestPropertyValues.js', ['forceSkinAction' : true, 'language' : context.locale])
 }

 def displaySearchSelect(propClass, name, prefix, query) {
        def select = new select(prefix + name, 1);
        select.setMultiple(true);
        select.setSize(1);
        select.setName(prefix + name);
        select.setID(prefix + name);
        select.setClass("suggest-propertyValues");

        def isMultiSelect = propClass.getProperty('multiSelect').value;
        def list = propClass.getListValues();
        def fieldFullName = name;
        def selectlist = query.get(fieldFullName);
        def pClass = propClass.getBasePropertyClass();        

        // Add options from Set
        for (String rawvalue : list) {
            String value = pClass.getElementValue(rawvalue);
            String display = pClass.getDisplayValue(rawvalue, fieldFullName, propClass.getMapValues(), context.getContext());
            def option = new option(display, value);
            option.addElement(display);
            if (selectlist!=null &amp;&amp; selectlist.contains(value)) {
                option.setSelected(true);
            }
            select.addElement(option);
        }

        if (isMultiSelect) {

        }

        return select.toString();
    }

 def makeQueryList(propClass, name, prefix, queryTablePrefix, map) {
       def clauseList = new ArrayList();
       def fullPropName = queryTablePrefix + name;
       def pClass = propClass.getBasePropertyClass();   
  
       def values = map.get(prefix);
        if ((values == null) || (values.equals(""))) {
            return clauseList;
        }
        def separator = pClass.isMultiSelect() ? " member of " : " = ";
        if (values instanceof String) {
            // general comparison '=' - tests at least one value =
            clauseList.add("'" + values.toString() + "'" + separator + fullPropName);
        } else {
            String[] valuesarray = (String[]) values;
            String[] criteriaarray = new String[valuesarray.length];
            for (int i = 0; i &lt; valuesarray.length; i++) {
                criteriaarray[i] = "'" + valuesarray[i] + "'" + separator + fullPropName;
            }
            clauseList.add("(" + StringUtils.join(criteriaarray, " or ") + ")");
        }
        return clauseList;
    }

    def makeQueryNumber(propClass, name, prefix, queryTablePrefix, map) {
        def clauseList = new ArrayList();
        def fullPropName = queryTablePrefix + name;

        String lessthan = (String) map.get(prefix + "_lessthan");
        String morethan = (String) map.get(prefix + "_morethan");
        if (lessthan &amp;&amp; lessthan!="") {
                clauseList.add(fullPropName + " &lt;= " + lessthan);
        } 
        if (morethan &amp;&amp; morethan!="") {
                clauseList.add(fullPropName + " &gt;=" + morethan);
        }

        /*
        value = (String) map.get(prefix + "exact");
        if ((value != null) &amp;&amp; (!value.equals(""))) {
            clauseList.add(fullPropName + "=" + value);
        }

        value = (String) map.get(prefix + "not");
        if ((value != null) &amp;&amp; (!value.equals(""))) {
            clauseList.add(fullPropName + "!=" + value);
        }
        */
        return clauseList;
  }

    def makeQueryDate(propClass, name, prefix, queryTablePrefix, map) {
        def clauseList = new ArrayList();
        def fullPropName = queryTablePrefix + name;

        String lessthan = (String) map.get(prefix + "_lessthan");
        String morethan = (String) map.get(prefix + "_morethan");
        if (lessthan &amp;&amp; lessthan!="") {
                clauseList.add(fullPropName + " &lt;= " + lessthan);
        } 
        if (morethan &amp;&amp; morethan!="") {
                clauseList.add(fullPropName + " &gt;=" + morethan);
        }

        /*
        value = (String) map.get(prefix + "exact");
        if ((value != null) &amp;&amp; (!value.equals(""))) {
            clauseList.add(fullPropName + "=" + value);
        }

        value = (String) map.get(prefix + "not");
        if ((value != null) &amp;&amp; (!value.equals(""))) {
            clauseList.add(fullPropName + "!=" + value);
        }
        */
        return clauseList;
  }

}
</content>
</xwikidoc>
